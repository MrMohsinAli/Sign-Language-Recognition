<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ASL Recognition Interface</title>
<style>
    /* --- THEME: Cyberpunk / Dark Mode --- */
    body { 
        background-color: #0b0b0b; 
        color: #00ff99; 
        font-family: 'Courier New', Courier, monospace; 
        margin: 0; 
        padding: 20px;
        display: flex;
        flex-direction: column;
        align-items: center;
        height: 100vh;
        box-sizing: border-box;
    }

    h2 { 
        text-transform: uppercase; 
        letter-spacing: 3px; 
        text-shadow: 0 0 8px #00ff99; 
        margin: 0 0 20px 0;
    }

    .main-container {
        display: flex;
        flex-direction: row;
        gap: 30px;
        width: 100%;
        max-width: 1200px;
        height: 85vh;
    }

    .input-section {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 15px;
    }

    .library-section {
        flex: 0.6;
        border: 1px solid #333;
        background: #111;
        border-radius: 10px;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    /* --- VIDEO FEED --- */
    .video-wrapper {
        position: relative;
        border: 2px solid #00ff99;
        border-radius: 8px;
        box-shadow: 0 0 20px rgba(0, 255, 153, 0.15);
        background: #000;
        width: 100%;
        padding-top: 56.25%; /* 16:9 Aspect Ratio */
        overflow: hidden;
    }

    video {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        object-fit: cover;
        transform: scaleX(-1); /* Mirror effect */
    }

    /* Hidden canvas for capturing frames */
    #captureCanvas {
        display: none;
    }

    /* --- DETECTION DISPLAY --- */
    .prediction-panel {
        display: flex;
        gap: 15px;
        align-items: stretch;
    }

    .current-char-box {
        background: rgba(0, 255, 153, 0.05);
        border: 1px solid #00ff99;
        border-radius: 6px;
        width: 130px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 10px;
    }

    #detectedChar {
        font-size: 60px;
        font-weight: bold;
        margin: 0;
        line-height: 1;
        text-shadow: 0 0 15px #00ff99;
    }
    
    .confidence-meter { font-size: 10px; opacity: 0.7; margin-top: 5px; }

    /* --- SENTENCE INPUT & BUTTONS --- */
    .sentence-box {
        flex-grow: 1;
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    #sentenceInput {
        background: #000;
        border: 1px solid #333;
        color: #fff;
        padding: 15px;
        font-size: 22px;
        border-radius: 6px;
        font-family: inherit;
        width: 100%;
        box-sizing: border-box;
    }

    .button-group {
        display: flex;
        gap: 10px;
        height: 45px;
    }

    button {
        flex: 1;
        border: none;
        border-radius: 4px;
        font-weight: bold;
        cursor: pointer;
        text-transform: uppercase;
        font-family: inherit;
        font-size: 12px;
        transition: 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 5px;
    }

    .btn-copy { background: #00ff99; color: #000; }
    .btn-copy:hover { background: #fff; box-shadow: 0 0 10px #fff; }

    .btn-backspace { background: #ffcc00; color: #000; }
    .btn-backspace:hover { background: #fff; box-shadow: 0 0 10px #ffcc00; }

    .btn-clear { background: #ff3333; color: white; }
    .btn-clear:hover { background: #ff6666; box-shadow: 0 0 10px #ff3333; }

    /* --- REFERENCE LIBRARY --- */
    .lib-header {
        padding: 15px;
        background: #1a1a1a;
        border-bottom: 1px solid #333;
        text-align: center;
        font-weight: bold;
    }

    .grid-scroller {
        padding: 15px;
        overflow-y: auto;
        height: 100%;
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
        gap: 10px;
    }

    .ref-card {
        background: #1a1a1a;
        border: 1px solid #333;
        border-radius: 8px;
        padding: 8px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
    }

    .ref-card img {
        width: 100%;
        height: 60px;
        object-fit: cover;
        border-radius: 4px;
        margin-bottom: 5px;
        filter: grayscale(100%) opacity(0.6);
        transition: 0.3s;
    }

    .ref-card span { font-size: 18px; font-weight: bold; color: #555; }

    .ref-card.active {
        border-color: #00ff99;
        background: rgba(0, 255, 153, 0.15);
        transform: scale(1.05);
        box-shadow: 0 0 15px rgba(0, 255, 153, 0.2);
    }
    .ref-card.active img { filter: none; opacity: 1; }
    .ref-card.active span { color: #00ff99; }

    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: #00ff99; }
</style>
</head>
<body>

    <h2>ü§ü Neural Sign Interface (Server Mode)</h2>

    <div class="main-container">
        <div class="input-section">
            <div class="video-wrapper">
                <video id="video" autoplay playsinline></video>
                <canvas id="captureCanvas"></canvas>
            </div>
            
            <div id="status" style="font-size:12px; color:#666; text-align:center;">
                Connecting to Python Backend...
            </div>

            <div class="prediction-panel">
                <div class="current-char-box">
                    <span style="font-size:10px; text-transform:uppercase; letter-spacing:1px;">Detected</span>
                    <div id="detectedChar">-</div>
                    <div class="confidence-meter" id="confidenceLevel">0%</div>
                </div>

                <div class="sentence-box">
                    <input type="text" id="sentenceInput" placeholder="Start signing..." readonly>
                    <div class="button-group">
                        <button class="btn-copy" onclick="copyToClipboard()">üìã Copy</button>
                        <button class="btn-backspace" onclick="backspace()">‚å´ Char</button>
                        <button class="btn-clear" onclick="clearSentence()">‚úï Clear All</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="library-section">
            <div class="lib-header">LOCAL LIBRARY</div>
            <div class="grid-scroller" id="referenceGrid"></div>
        </div>
    </div>

    <script>
        const video = document.getElementById("video");
        const canvas = document.getElementById("captureCanvas");
        const ctx = canvas.getContext("2d");
        const statusDiv = document.getElementById("status");
        const detectedCharDiv = document.getElementById("detectedChar");
        const confidenceDiv = document.getElementById("confidenceLevel");
        const sentenceInput = document.getElementById("sentenceInput");
        const referenceGrid = document.getElementById("referenceGrid");

        // Logic variables
        let lastChar = "";
        let streak = 0;
        const STREAK_THRESHOLD = 5; // How many consistent frames to confirm letter
        const SEND_INTERVAL = 150;  // Send image every 150ms (Approx 6-7 FPS)

        // Updated Labels list (Matches your Python Backend)
        const LABELS = ['A','B','C','D','E','F','G','H','I','J','K','L','M',
                        'N','O','P','Q','R','S','T','U','V','W','X','Y','Z','Space','Delete'];

        // 1. Initialize Reference Library
        function initLibrary() {
            LABELS.forEach(char => {
                if (char === "Delete") return; // Don't show Delete in library

                const div = document.createElement("div");
                div.className = "ref-card";
                div.id = `ref-${char}`;

                // Filename logic based on your previous screenshot
                let filename;
                if(char === "Space") {
                    filename = "space_test.jpg";
                } else {
                    filename = `${char}_test.jpg`;
                }

                div.innerHTML = `
                    <img src="/static/images/${filename}" alt="${char}" onerror="this.parentElement.style.opacity='0.5'">
                    <span>${char === "Space" ? "‚ê£" : char}</span>
                `;
                referenceGrid.appendChild(div);
            });
        }

        // 2. Start Camera
        async function setupCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { width: 640, height: 480 } 
                });
                video.srcObject = stream;
                statusDiv.innerText = "Camera Active. Sending frames to Python...";
                statusDiv.style.color = "#00ff99";
                
                // Start the sending loop
                setInterval(sendFrameToBackend, SEND_INTERVAL);
                
            } catch (err) {
                statusDiv.innerText = "Error: " + err.message;
                statusDiv.style.color = "red";
            }
        }

        // 3. Capture & Send Frame
        function sendFrameToBackend() {
            // Draw video frame to canvas
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

            // Convert to Base64 (JPEG format is faster/smaller than PNG)
            const dataURL = canvas.toDataURL("image/jpeg", 0.7);

            // POST to Flask
            fetch("/predict", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ image: dataURL })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    console.error("Backend Error:", data.error);
                } else if (data.prediction) {
                    updateUI(data.prediction, data.confidence);
                } else {
                    // No hand detected
                    detectedCharDiv.innerText = "-";
                    confidenceDiv.innerText = "0%";
                    highlightGrid(null);
                }
            })
            .catch(err => console.error("Network Error:", err));
        }

        // 4. Update UI & Sentence Logic
        function updateUI(char, confidence) {
            detectedCharDiv.innerText = char === "Space" ? "‚ê£" : char;
            confidenceDiv.innerText = Math.round(confidence * 100) + "%";

            highlightGrid(char);

            // Sentence Building
            if (char === lastChar) {
                streak++;
                if (streak === STREAK_THRESHOLD) {
                    handleConfirmedChar(char);
                    streak = 0; // Reset streak after adding
                }
            } else {
                streak = 0;
                lastChar = char;
            }
        }

        function handleConfirmedChar(char) {
            // Flash effect
            detectedCharDiv.style.textShadow = "0 0 30px #fff";
            setTimeout(() => detectedCharDiv.style.textShadow = "0 0 15px #00ff99", 200);

            if (char === "Delete") {
                backspace();
            } else if (char === "Space") {
                sentenceInput.value += " ";
            } else {
                sentenceInput.value += char;
            }
            sentenceInput.scrollLeft = sentenceInput.scrollWidth;
        }

        function highlightGrid(char) {
            document.querySelectorAll(".ref-card.active").forEach(el => el.classList.remove("active"));
            if(char && char !== "Delete") {
                const el = document.getElementById(`ref-${char}`);
                if(el) {
                    el.classList.add("active");
                    el.scrollIntoView({ behavior: "smooth", block: "nearest" });
                }
            }
        }

        // 5. Button Functions
        function backspace() {
            sentenceInput.value = sentenceInput.value.slice(0, -1);
            streak = 0;
        }

        function clearSentence() {
            sentenceInput.value = "";
            streak = 0;
        }

        function copyToClipboard() {
            if(!sentenceInput.value) return;
            navigator.clipboard.writeText(sentenceInput.value);
            const btn = document.querySelector(".btn-copy");
            const original = btn.innerText;
            btn.innerText = "COPIED!";
            setTimeout(() => btn.innerText = original, 1000);
        }

        // Start
        window.onload = () => {
            initLibrary();
            setupCamera();
        };
    </script>
</body>
</html>